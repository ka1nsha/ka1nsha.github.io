
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="0x656e" />
        <meta name="keywords" content="python,requests,parser,lxml" />
        <meta name="description" content="Selamlar arkadaşlar bu postta twitterda bir arkadaşımın paylaştığı linkte bulunan verileri çekeceğiz.Bu kod beni baya bi uğraştırdı. Aslında uğraştırmaması gerekiyordu fakat ilk olarak parse etmek için regex kullanmayı düşündüm.Fakat regex ile yeterince hızlı olmuyordu bu işlem xpath kullanmak istedim işte tüm sorunlar bundan sonra başladı.Öncelikle çekeceğimiz linki …" />


    <title>TSF Parser - 0x6 | Junior of All</title>

        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css" />

    <link href="/theme/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/theme/css/pygments/native.css" rel="stylesheet" />
    
    <link href="/theme/css/pelican-twitchy.min.css" rel="stylesheet" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <!-- Feeds -->
</head>
<body data-spy="scroll" data-target="#scrollspy">
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper-small" class="twitchy-background">
            <ul id="accordion-small" class="sidebar-nav sidebar-nav-small">
                <li>
        <a href="" title="0x6 | Junior of All" class="collapsed">
            <span class="glyphicon glyphicon-home"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
        <a href="/archives.html" title="Recent Articles" class="collapsed">
            <span class="glyphicon glyphicon-th-list"></span>
        </a>
    </li>
                
                <li class="nav-divider"></li>
                <li id="share-small">
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-share-small" title="Share" class="collapsed">
                        <i class="fa fa-share-alt padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-share-small" class="collapse ">
                    <li>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=/tsf-parser.html" title="Share via Facebook" target="popup">
                            <i class="fa fa-facebook-square padding-small"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://plus.google.com/share?url=/tsf-parser.html" title="Share via Google+" target="popup">
                            <i class="fa fa-google-plus padding-small"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" title="Share via Twitter" target="popup">
                            <i class="fa fa-twitter-square padding-small"></i>
                        </a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-social-small" title="Social" class="collapsed">
                        <i class="fa fa-users padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social-small" class="collapse ">
                    <li>
                        <a href="www.twitter.com/0x656e" title="0x656e"><i class="fa fa-0x656e-square fa-lg padding-small"></i></a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
        <a href="#" title="Back to top" class="collapsed">
            <span class="fa fa-arrow-up"></span>
        </a>
    </li>
            </ul>
        </div>
        <div id="sidebar-wrapper" class="twitchy-background">
            <ul id="accordion" class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/">
                            <span class="glyphicon glyphicon-home padding-small"></span>
                            0x6 | Junior of All
                    </a>
                </li>
                    <li class="nav-divider"></li>
                    <li>
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse-latest">
                            <span class="glyphicon glyphicon-th-list padding-small"></span>
                            Recent Articles
                        </a>
                    </li>
                    <li class="panel anti-panel"><ul id="collapse-latest" class="sidebar_submenu collapse in">
                        <li class="active">
                            <a class="hide-overflow" href="/tsf-parser.html" title="TSF Parser">
                                <i class="fa fa-file-text padding-small"></i>
                                TSF Parser
                            </a>
                        </li>
                        <li class="">
                            <a class="hide-overflow" href="/zone-h-parser.html" title="Zone-H Parser">
                                <i class="fa fa-file-text padding-small"></i>
                                Zone-H Parser
                            </a>
                        </li>
                        <li class="">
                            <a class="hide-overflow" href="/python-vulnhub-author-scraper.html" title="Python ile basit vulnhub yazarlarını çeken bot">
                                <i class="fa fa-file-text padding-small"></i>
                                Python ile basit vulnhub yazarlarını çeken bot
                            </a>
                        </li>
                    <li>
                        <a href="/archives.html">
                            <i class="fa fa-arrow-right padding-small"></i>
                            More
                        </a>
                    </li>
                    </ul></li>
                <li class="nav-divider"></li>
                <li id="share">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-share" title="Share" class="collapsed">
                        <i class="fa fa-share-alt padding-small"></i>
                        Share
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-share" class="sidebar_submenu collapse ">
                    <li>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=/tsf-parser.html" target="popup">
                            <i class="fa fa-facebook-square padding-small"></i>
                            Facebook
                        </a>
                    </li>
                    <li>
                        <a href="https://plus.google.com/share?url=/tsf-parser.html" target="popup">
                            <i class="fa fa-google-plus padding-small"></i>
                            Google+
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" target="popup">
                            <i class="fa fa-twitter-square padding-small"></i>
                            Twitter
                        </a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-social">
                        <i class="fa fa-users padding-small"></i>
                        Contact
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social" class="sidebar_submenu collapse ">
                    <li>
                        <a href="www.twitter.com/0x656e" title="0x656e">
                            <i class="fa fa-0x656e-square fa-lg padding-small"></i>
                            0x656e
                        </a>
                    </li>
                </ul></li>
                
                
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-categories">
                        <i class="fa fa-folder-open padding-small"></i>
                        Categories
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-categories" class="sidebar_submenu collapse ">
                    <li class="active">
                        <a href="/category/python.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            python
                            <span class="badge pull-right categorybadge">3</span>
                        </a>
                    </li>
                </ul></li>
                
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->
        <!-- open/close sidebar -->
        <a href="#menu-toggle" class="btn btn-default" id="menu-toggle">
            <span id="right-arrow" class="glyphicon glyphicon-chevron-right"  title="expand sidebar"></span>
            <span id="left-arrow" class="glyphicon glyphicon-chevron-left" title="minimize sidebar"></span>
        </a>
       <!-- /open/close sidebar -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
<section id="content">
    <article>
        <div class="row">
            <div class="col-lg-9">
                <header class="page-header">
                    <h1>
                        <a href="/tsf-parser.html"
                           rel="bookmark"
                           title="Permalink to TSF Parser">
                            TSF Parser
                        </a>
                        <small>
<div class="post-info">
    <div class="publish-info-block">
        <small>
            <span class="published">
                <i class="fa fa-calendar padding-small"></i><time datetime="2016-06-28T10:20:00+03:00"> Tue 28 June 2016</time>
            </span>
            <span class="category">
                <i class="fa fa-folder-open padding-small"></i><a href="/category/python.html">python</a>
            </span>
            <span class="tags">
                <i class="fa fa-tags padding-small"></i>
                <a href="/tag/python.html">python</a> /                 <a href="/tag/requests.html">requests</a> /                 <a href="/tag/parser.html">parser</a> /                 <a href="/tag/lxml.html">lxml</a>            </span>
        </small>
    </div>
</div><!-- /.post-info -->                        </small>
                    </h1>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-9">
                <div class="entry-content">
                    <p>Selamlar arkadaşlar bu postta twitterda bir arkadaşımın paylaştığı linkte bulunan verileri çekeceğiz.Bu kod beni baya bi uğraştırdı. Aslında uğraştırmaması gerekiyordu fakat ilk olarak parse etmek için regex kullanmayı düşündüm.Fakat regex ile yeterince hızlı olmuyordu bu işlem xpath kullanmak istedim işte tüm sorunlar bundan sonra başladı.Öncelikle çekeceğimiz linki vereyim. <a href="https://lisans.tsf.org.tr/online/main/kulupliste/">Tsf.org.tr</a>  Siteye girdiğinizde eğer bir külubü görüntülerseniz özel id atandığını göreceksiniz.Yani aslında arkaplanda post ile verileri alırken 206 id li veriyi çekiyor fakat adress bar da bu 100545254 şeklinde gözükmekte. Eğer bunu farketmeseydim her döngüde 1 artan bir değişkenle işimi halletmeye çalışacaktım.Bu işlem epey uzun oluyordu :)</p>
<p>Bende xpath ile o açılır menüde ki kulüplerin id lerini ve isimlerini aldım.Daha sonra bi def içinde gerekli olan sayfayı bulup ona göre döngüye devam ediyordu.</p>
<p>Fakat bu büyük bir soruna yol açtı bunu sadece 1 kere yapıyordu.Yani 25 sayfa aldıysa sonradan yeniden sayfalar açılırsa ( <strong> Ki bazı kulüpler 2600 sayfa  </strong>) bunu es geçiyordu.</p>
<p>Neyse kodumuzun ilk haline bakalım.(  <strong>Hataları olabilir bir süre sonra elleşmedim oraya hiç  </strong>)</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">html</span>
<span class="kn">import</span> <span class="nn">adddb</span>

<span class="n">disct</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://lisans.tsf.org.tr/online/main/kulupliste/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">i</span>
    <span class="n">ac</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">lx</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">sayfaid</span>
    <span class="n">sayfaid</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[@class=&quot;pagenavdiv&quot;]/a[@href]/text()&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sayfaid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sayfaid</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
<span class="k">def</span> <span class="nf">multiplelist</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">http</span> <span class="o">=</span> <span class="s2">&quot;https://lisans.tsf.org.tr/online/main/kulupliste/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">number</span><span class="p">)</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
        <span class="n">lx</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">isim</span><span class="p">,</span><span class="n">soyisim</span><span class="p">,</span><span class="n">dyil</span><span class="p">,</span><span class="n">il</span>
        <span class="n">isim</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[2]/text()&#39;</span><span class="p">)</span>
        <span class="n">soyisim</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[3]/text()&#39;</span><span class="p">)</span>
        <span class="n">dyil</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[4]/text()&#39;</span><span class="p">)</span>
        <span class="n">il</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[5]/text()&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>



<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://lisans.tsf.org.tr/online/main/kulupliste&quot;</span>
<span class="n">ac</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">lx</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="nb">id</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;/html/body//option/@value&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>

    <span class="k">if</span> <span class="n">analyze</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">multiplelist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">sayfaid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="s2">&quot;Son&quot;</span><span class="p">:</span>
                <span class="n">analyze</span><span class="p">(</span><span class="n">sayfaid</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">multiplelist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">u</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">isim</span><span class="p">)):</span>
                <span class="n">isimsoyisim</span> <span class="o">=</span> <span class="n">isim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">soyisim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">disct</span><span class="p">[</span><span class="n">isimsoyisim</span><span class="p">]</span> <span class="o">=</span> <span class="n">dyil</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">il</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>


<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">disct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">adddb</span><span class="o">.</span><span class="n">dbadd</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>Gördüğünüz gibi burada analiz ettikten sonra artık değişen birşey olmuyordu. Üstelik bütün siteyi parse ettikten sonra db ye ekliyordu bu da herhangi bir hata da hiç bir verinin kaydedilemeyeceği anlamına geliyordu.</p>
<p>Ama bundan önce bütün listelerin parse edilip tekrar aynı id ile birleştirilmesi koddan anlayabilirsiniz zaten buda bir sürü soruna sebep oldu.Verilerin tam kaydedilmemesi üst üste gelmesi yani verilerde eksik bulunuyordu. Neyse kod şu hale update edildi ( En sorunsuz sürüm sanırım )</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">html</span>
<span class="kn">import</span> <span class="nn">adddb</span>
<span class="k">def</span> <span class="nf">multiplelist</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="n">http</span> <span class="o">=</span> <span class="s2">&quot;https://lisans.tsf.org.tr/online/main/kulupliste/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
            <span class="n">lx</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">isim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">soyisim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dyil</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">il</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">isim</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[2]/text()&#39;</span><span class="p">)</span>
            <span class="n">soyisim</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[3]/text()&#39;</span><span class="p">)</span>
            <span class="n">dyil</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[4]/text()&#39;</span><span class="p">)</span>
            <span class="n">il</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[5]/text()&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">isim</span><span class="p">)):</span>
                <span class="n">isimsoyisim</span> <span class="o">=</span> <span class="n">isim</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">soyisim</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">adddb</span><span class="o">.</span><span class="n">dbadd</span><span class="p">(</span><span class="n">isimsoyisim</span><span class="p">,</span><span class="n">dyil</span><span class="p">[</span><span class="n">f</span><span class="p">],</span><span class="n">il</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="n">sayfasayisi</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://lisans.tsf.org.tr/online/main/kulupliste&quot;</span>
<span class="n">ac</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">lx</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="nb">id</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;/html/body//option/@value&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;/html/body//option/text()&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;([0-9]{0,9}).Sporcu&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">//</span><span class="mi">15</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">sayfasayisi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">u</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">sayfasayisi</span><span class="p">):</span>
    <span class="n">multiplelist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">u</span><span class="p">)</span>
</pre></div>


<p>Bu da iyi hoştu ama netim sağlam olmadığı için arkadaşlarda çalıştırdığımızda verileri tam olarak çekmiyordu toplamda 9000 küsür veri çekiyordu.Büyük ihtimal sunucumuz belli bir request den sonra bizi drop ediyordu ve bizde çok az veri yazabiliyorduk.</p>
<p>Neyse buna da bir çözüm bulduk.Daha önce Robin Dimyan bilmem ne :D adlı arkadaşın kodunda kullandığı tor reload kullandım.Test ettiğimde sorunsuz gözüküyordu fakat siteyi tam olarak çekemedim ne yazık ki.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span><span class="o">,</span><span class="nn">socks</span><span class="o">,</span><span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">call</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">html</span>

<span class="kn">import</span> <span class="nn">adddb</span><span class="o">,</span><span class="nn">re</span>


<span class="k">def</span> <span class="nf">tor_reload</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;sudo systemctl reload tor&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Successfully Connected to New Tor Circuit!&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Can&#39;t changed the Tor node, checking tor status and starting if doesn&#39;t working...&quot;</span><span class="p">)</span>
    <span class="n">socks</span><span class="o">.</span><span class="n">setdefaultproxy</span><span class="p">(</span><span class="n">socks</span><span class="o">.</span><span class="n">PROXY_TYPE_SOCKS5</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">9050</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socks</span><span class="o">.</span><span class="n">socksocket</span>


<span class="k">def</span> <span class="nf">multiplelist</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="n">http</span> <span class="o">=</span> <span class="s2">&quot;https://lisans.tsf.org.tr/online/main/kulupliste/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
            <span class="n">lx</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">isim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">soyisim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dyil</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">il</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">isim</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[2]/text()&#39;</span><span class="p">)</span>
            <span class="n">soyisim</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[3]/text()&#39;</span><span class="p">)</span>
            <span class="n">dyil</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[4]/text()&#39;</span><span class="p">)</span>
            <span class="n">il</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//table[@class=&quot;lisans-table&quot;]//tr/td[5]/text()&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">isim</span><span class="p">)):</span>
                <span class="n">isimsoyisim</span> <span class="o">=</span> <span class="n">isim</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">soyisim</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">adddb</span><span class="o">.</span><span class="n">dbadd</span><span class="p">(</span><span class="n">isimsoyisim</span><span class="p">,</span><span class="n">dyil</span><span class="p">[</span><span class="n">f</span><span class="p">],</span><span class="n">il</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="n">sayfasayisi</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://lisans.tsf.org.tr/online/main/kulupliste&quot;</span>
<span class="n">ac</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">lx</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="nb">id</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;/html/body//option/@value&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;/html/body//option/text()&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;([0-9]{0,9}).Sporcu&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">//</span><span class="mi">15</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">sayfasayisi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">u</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">sayfasayisi</span><span class="p">):</span>
    <span class="n">multiplelist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">u</span><span class="p">)</span>
    <span class="n">tor_reload</span><span class="p">()</span>
</pre></div>


<p>Bu arada burada kodda sayfa sayısını toplamsporcu//15+1 ile alıyorum.Hiç değilse daha sağlıklı oluyor.</p>
<p>Scriptte kullandığım diğer kodlar şu şekildedir.</p>
<p>adddb.py'ın dosya içeriği : </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="k">def</span> <span class="nf">dbadd</span><span class="p">(</span><span class="n">isim</span><span class="p">,</span><span class="n">yil</span><span class="p">,</span><span class="n">il</span><span class="p">):</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;tsf.db&quot;</span><span class="p">)</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO tsflicense(isim,dyil,il) VALUES (?,?,?)&quot;</span><span class="p">,(</span><span class="n">isim</span><span class="p">,</span><span class="n">yil</span><span class="p">,</span><span class="n">il</span><span class="p">,))</span>
    <span class="n">op</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">op</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>Not : Burada ki kodlar tamamen eğitim amaçlıdır.Kullanımınızdan doğan herhangi bir yasal sorunda mesuliyet kabul etmem.Yazı hakkında ki yasal sorunlar vs iletişime geçmek için : <a href="emailto:r4wn3ss@gmail.com">Email</a> </p>
                </div>
                <footer class="text-right">
                    <p>- 0x656e</p>
                </footer>
    <section id="comments" class="comments ">
        <hr/>
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>
            </div>
        </div>
    </article>
</section>
<footer>
    <hr>
    <div class="row">
        <div class="col-lg-9 text-center">
            <p><small>
                Built by <a href="http://docs.getpelican.com/en/latest">Pelican</a> / <a href="https://github.com/ingwinlu/pelican-twitchy">pelican-twitchy</a>
                &middot;                    &copy; 2016 0x656e
            </small></p>
        </div>
    </div>
</footer>            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->
    <!-- jQuery Version 1.11.2 -->
    <script src="/theme/js/jquery-1.11.2.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>
    <!-- twitchy Script -->
    <script src="/theme/js/pelican_twitchy.min.js"></script>
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-44262671-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->
</body>
<script id="dsq-count-scr" src="//0x656e.disqus.com/count.js" async></script>

</html>